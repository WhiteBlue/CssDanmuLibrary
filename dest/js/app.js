var __extends=function(r,n){var e=function(){};e.prototype=n.prototype;var t=new e;t.constructor=r,r.prototype=t},BinArray=function(){var r={};return r.bsearch=function(r,n,e){if(0===r.length)return 0;if(e(n,r[0])<0)return 0;if(e(n,r[r.length-1])>=0)return r.length;for(var t=0,o=0,u=0,c=r.length-1;c>=t;){if(o=Math.floor((c+t+1)/2),u++,e(n,r[o-1])>=0&&e(n,r[o])<0)return o;e(n,r[o-1])<0?c=o-1:e(n,r[o])>=0?t=o:console.error("Judge error at : "+e),u>1500&&console.error("Too many run cycles.")}return-1},r.binsert=function(n,e,t){var o=r.bsearch(n,e,t);return n.splice(o,0,e),o},r}();
function BilibiliParser(e,a,r){function t(e){return e.replace(/\t/,"\\t")}if(null!==e)var n=e.getElementsByTagName("d");else{if(!document||!document.createElement)return[];if(r){if(!confirm("XML Parse Error. \n Allow tag soup parsing?\n[WARNING: This is unsafe.]"))return[]}else a=a.replace(new RegExp("</([^d])","g"),"</disabled $1"),a=a.replace(new RegExp("</(S{2,})","g"),"</disabled $1"),a=a.replace(new RegExp("<([^d/]W*?)","g"),"<disabled $1"),a=a.replace(new RegExp("<([^/ ]{2,}W*?)","g"),"<disabled $1");var o=document.createElement("div");o.innerHTML=a;var n=o.getElementsByTagName("d")}for(var l=[],d=0;d<n.length;d++)if(null!=n[d].getAttribute("p")){var s=n[d].getAttribute("p").split(",");if(!n[d].childNodes[0])continue;var a=n[d].childNodes[0].nodeValue,i={};if(i.stime=Math.round(1e3*parseFloat(s[0])),i.size=parseInt(s[2]),i.color=parseInt(s[3]),i.mode=parseInt(s[1]),i.date=parseInt(s[4]),i.pool=parseInt(s[5]),i.position="absolute",null!=s[7]&&(i.dbid=parseInt(s[7])),i.hash=s[6],i.border=!1,i.mode<7)i.text=a.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==i.mode)try{if(adv=JSON.parse(t(a)),i.shadow=!0,i.x=parseFloat(adv[0]),i.y=parseFloat(adv[1]),(Math.floor(i.x)<i.x||Math.floor(i.y)<i.y)&&(i.position="relative"),i.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),i.rZ=0,i.rY=0,adv.length>=7&&(i.rZ=parseInt(adv[5],10),i.rY=parseInt(adv[6],10)),i.motion=[],i.movable=!1,adv.length>=11){i.movable=!0;var p=500,u={x:{from:i.x,to:parseFloat(adv[7]),dur:p,delay:0},y:{from:i.y,to:parseFloat(adv[8]),dur:p,delay:0}};if(""!==adv[9]&&(p=parseInt(adv[9],10),u.x.dur=p,u.y.dur=p),""!==adv[10]&&(u.x.delay=parseInt(adv[10],10),u.y.delay=parseInt(adv[10],10)),adv.length>11&&(i.shadow=adv[11],"true"===i.shadow&&(i.shadow=!0),"false"===i.shadow&&(i.shadow=!1),null!=adv[12]&&(i.font=adv[12]),adv.length>14)){"relative"===i.position&&(console.log("Cannot mix relative and absolute positioning"),i.position="absolute");for(var v=adv[14],c={x:u.x.from,y:u.y.from},g=[],f=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),m=v.split(/[a-zA-Z]/).length-1,h=f.exec(v);null!==h;){switch(h[1]){case"M":c.x=parseInt(h[2],10),c.y=parseInt(h[3],10);break;case"L":g.push({x:{from:c.x,to:parseInt(h[2],10),dur:p/m,delay:0},y:{from:c.y,to:parseInt(h[3],10),dur:p/m,delay:0}}),c.x=parseInt(h[2],10),c.y=parseInt(h[3],10)}h=f.exec(v)}u=null,i.motion=g}null!==u&&i.motion.push(u)}i.dur=2500,adv[3]<12&&(i.dur=1e3*adv[3]);var o=adv[2].split("-");if(null!=o&&o.length>1){var x=parseFloat(o[0]),y=parseFloat(o[1]);i.opacity=x,x!==y&&(i.alpha={from:x,to:y})}}catch(I){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+a)}else 8==i.mode&&(i.code=a);null!=i.text&&(i.text=i.text.replace(/\u25a0/g,"â–ˆ")),l.push(i)}return l}
var CoreComment=function(){function t(i,o){if("undefined"==typeof o&&(o={}),this.mode=1,this.stime=0,this.text="",this.ttl=4e3,this.dur=4e3,this.cindex=-1,this.motion=[],this.movable=!0,this._alphaMotion=null,this.absolute=!0,this.align=0,this._alpha=1,this._size=25,this._color=16777215,this._border=!1,this._shadow=!0,this._font="",!i)throw new Error("Comment not bind to comment manager.");if(this.parent=i,o.hasOwnProperty("stime")&&(this.stime=o.stime),o.hasOwnProperty("mode")?this.mode=o.mode:this.mode=1,o.hasOwnProperty("dur")&&(this.dur=o.dur,this.ttl=this.dur),this.dur*=this.parent.options.global.scale,this.ttl*=this.parent.options.global.scale,o.hasOwnProperty("text")&&(this.text=o.text),o.hasOwnProperty("motion")){this._motionStart=[],this._motionEnd=[],this.motion=o.motion;for(var s=0,e=0;e<o.motion.length;e++){this._motionStart.push(s);var h=0;for(var n in o.motion[e]){var r=o.motion[e][n];h=Math.max(r.dur,h),(null===r.easing||void 0===r.easing)&&(o.motion[e][n].easing=t.LINEAR)}s+=h,this._motionEnd.push(s)}this._curMotion=0}o.hasOwnProperty("color")&&(this._color=o.color),o.hasOwnProperty("size")&&(this._size=o.size),o.hasOwnProperty("border")&&(this._border=o.border),o.hasOwnProperty("opacity")&&(this._alpha=o.opacity),o.hasOwnProperty("alpha")&&(this._alphaMotion=o.alpha),o.hasOwnProperty("font")&&(this._font=o.font),o.hasOwnProperty("x")&&(this._x=o.x),o.hasOwnProperty("y")&&(this._y=o.y),o.hasOwnProperty("shadow")&&(this._shadow=o.shadow),o.hasOwnProperty("position")&&"relative"===o.position&&(this.absolute=!1,this.mode<7&&console.warn("Using relative position for CSA comment."))}return t.prototype.init=function(t){"undefined"==typeof t&&(t=null),null!==t?this.dom=t.dom:this.dom=document.createElement("div"),this.dom.className=this.parent.options.global.className,this.dom.appendChild(document.createTextNode(this.text)),this.dom.textContent=this.text,this.dom.innerText=this.text,this.size=this._size,16777215!=this._color&&(this.color=this._color),this.shadow=this._shadow,this._border&&(this.border=this._border),""!==this._font&&(this.font=this._font),void 0!==this._x&&(this.x=this._x),void 0!==this._y&&(this.y=this._y),(1!==this._alpha||this.parent.options.global.opacity<1)&&(this.alpha=this._alpha),this.motion.length>0&&this.animate()},Object.defineProperty(t.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this.align%2===0?this._x=this.dom.offsetLeft:this._x=this.parent.width-this.dom.offsetLeft-this.width),this.absolute?this._x:this._x/this.parent.width},set:function(t){this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this.align<2?this._y=this.dom.offsetTop:this._y=this.parent.height-this.dom.offsetTop-this.height),this.absolute?this._y:this._y/this.parent.height},set:function(t){this._y=t,this.absolute||(this._y*=this.parent.height),this.align<2?this.dom.style.top=this._y+"px":this.dom.style.bottom=this._y+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var i=t.toString(16);i=i.length>=6?i:new Array(6-i.length+1).join("0")+i,this.dom.style.color="#"+i,0===this._color&&(this.dom.className=this.parent.options.global.className+" rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(this._alpha,this.parent.options.global.opacity)+""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t,this._border?this.dom.style.border="1px solid #00ffff":this.dom.style.border="none"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._shadow},set:function(t){this._shadow=t,this._shadow||(this.dom.className=this.parent.options.global.className+" noshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t,this._font.length>0?this.dom.style.fontFamily=this._font:this.dom.style.fontFamily=""},enumerable:!0,configurable:!0}),t.prototype.time=function(t){this.ttl-=t,this.ttl<0&&(this.ttl=0),this.movable&&this.update(),this.ttl<=0&&this.finish()},t.prototype.update=function(){this.animate()},t.prototype.invalidate=function(){this._x=null,this._y=null,this._width=null,this._height=null},t.prototype._execMotion=function(t,i){for(var o in t)if(t.hasOwnProperty(o)){var s=t[o];this[o]=s.easing(Math.min(Math.max(i-s.delay,0),s.dur),s.from,s.to-s.from,s.dur)}},t.prototype.animate=function(){if(this._alphaMotion&&(this.alpha=(this.dur-this.ttl)*(this._alphaMotion.to-this._alphaMotion.from)/this.dur+this._alphaMotion.from),0!==this.motion.length){var t=Math.max(this.ttl,0),i=this.dur-t-this._motionStart[this._curMotion];return this._execMotion(this.motion[this._curMotion],i),this.dur-t>this._motionEnd[this._curMotion]?(this._curMotion++,void(this._curMotion>=this.motion.length&&(this._curMotion=this.motion.length-1))):void 0}},t.prototype.finish=function(){this.parent.finish(this)},t.prototype.toString=function(){return["[",this.stime,"|",this.ttl,"/",this.dur,"]","(",this.mode,")",this.text].join("")},t.LINEAR=function(t,i,o,s){return t*o/s+i},t}(),ScrollComment=function(t){function i(i,o){t.call(this,i,o),this.dur*=this.parent.options.scroll.scale,this.ttl*=this.parent.options.scroll.scale}return __extends(i,t),Object.defineProperty(i.prototype,"alpha",{set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(Math.min(this._alpha,this.parent.options.global.opacity),this.parent.options.scroll.opacity)+""},enumerable:!0,configurable:!0}),i.prototype.init=function(i){"undefined"==typeof i&&(i=null),t.prototype.init.call(this,i),this.x=this.parent.width,this.parent.options.scroll.opacity<1&&(this.alpha=this._alpha),this.absolute=!0},i.prototype.update=function(){this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width},i}(CoreComment),CSSCompatLayer=function(){function t(){}return t.transform=function(t,i){t.style.transform=i,t.style.webkitTransform=i,t.style.msTransform=i,t.style.oTransform=i},t}(),CSSScrollComment=function(t){function i(){t.apply(this,arguments),this._dirtyCSS=!0}return __extends(i,t),Object.defineProperty(i.prototype,"x",{get:function(){return this.ttl/this.dur*(this.parent.width+this.width)-this.width},set:function(t){if("number"==typeof this._x){var i=t-this._x;this._x=t,CSSCompatLayer.transform(this.dom,"translateX("+i+"px)")}else this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),i.prototype.update=function(){this._dirtyCSS&&(this.dom.style.transition="transform "+this.ttl+"ms linear",this.x=-this.width,this._dirtyCSS=!1)},i.prototype.invalidate=function(){t.prototype.invalidate.call(this),this._dirtyCSS=!0},i.prototype.stop=function(){this.dom.style.transition="",this.x=this._x,this._x=null,this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width,this._dirtyCSS=!0},i}(ScrollComment);
var CommentSpaceAllocator=function(){function t(t,o){this._pools=[[]],this.avoid=1,this._width=t,this._height=o}return t.prototype.willCollide=function(t,o){return t.stime+t.ttl>=o.stime+o.ttl/2},t.prototype.pathCheck=function(t,o,i){for(var e=0;e<i.length;e++)if(i[e].y>t+o.height||i[e].bottom<t);else{if(!(i[e].right<o.x||i[e].x>o.right))return!1;if(this.willCollide(i[e],o))return!1}return!0},t.prototype.assign=function(t,o){for(;this._pools.length<=o;)this._pools.push([]);var i=this._pools[o];if(0===i.length)return t.cindex=o,0;if(this.pathCheck(0,t,i))return t.cindex=o,0;for(var e=0,n=0;n<i.length&&(e=i[n].bottom+this.avoid,!(e+t.height>this._height));n++)if(this.pathCheck(e,t,i))return t.cindex=o,e;return this.assign(t,o+1)},t.prototype.add=function(t){t.height>this._height?(t.cindex=-2,t.y=0):(t.y=this.assign(t,0),BinArray.binsert(this._pools[t.cindex],t,function(t,o){return t.bottom<o.bottom?-1:t.bottom>o.bottom?1:0}))},t.prototype.remove=function(t){if(!(t.cindex<0)){if(t.cindex>=this._pools.length)throw new Error("cindex out of bounds");var o=this._pools[t.cindex].indexOf(t);0>o||this._pools[t.cindex].splice(o,1)}},t.prototype.setBounds=function(t,o){this._width=t,this._height=o},t}(),AnchorCommentSpaceAllocator=function(t){function o(){t.apply(this,arguments)}return __extends(o,t),o.prototype.add=function(o){t.prototype.add.call(this,o),o.x=(this._width-o.width)/2},o.prototype.willCollide=function(t,o){return!0},o.prototype.pathCheck=function(t,o,i){for(var e=t+o.height,n=0;n<i.length;n++)if(!(i[n].y>e||i[n].bottom<t))return!1;return!0},o}(CommentSpaceAllocator);
var CommentManager=function(){function t(t){var e=0;this.stage=t,this.options={global:{opacity:1,scale:1,className:"cmt"},scroll:{opacity:1,scale:1},limit:0},this.timeline=[],this.runline=[],this.position=0,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new AnchorCommentSpaceAllocator(0,0),bottom:new AnchorCommentSpaceAllocator(0,0),reverse:new CommentSpaceAllocator(0,0),scrollbtm:new CommentSpaceAllocator(0,0)},this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.startTimer=function(){if(!(e>0)){var t=(new Date).getTime(),i=this;e=window.setInterval(function(){var e=(new Date).getTime()-t;t=(new Date).getTime(),i.onTimerEvent(e,i)},10)}},this.stopTimer=function(){window.clearInterval(e),e=0}}return t.prototype.stop=function(){this.stopTimer()},t.prototype.start=function(){this.startTimer()},t.prototype.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight;for(var t in this.csa)this.csa[t].setBounds(this.width,this.height);this.stage.style.perspective=this.width*Math.tan(40*Math.PI/180)/2+"px",this.stage.style.webkitPerspective=this.width*Math.tan(40*Math.PI/180)/2+"px"},t.prototype.seek=function(t){this.position=BinArray.bsearch(this.timeline,t,function(t,e){return t<e.stime?-1:t>e.stime?1:0})},t.prototype.send=function(t){var e=1===t.mode||2===t.mode||6===t.mode?new CSSScrollComment(this,t):e=new CoreComment(this,t);switch(e.mode){case 1:e.align=0;break;case 2:e.align=2;break;case 4:e.align=2;break;case 5:e.align=0;break;case 6:e.align=1}switch(e.init(),this.stage.appendChild(e.dom),e.mode){case 1:this.csa.scroll.add(e);break;case 2:this.csa.scrollbtm.add(e);break;case 4:this.csa.bottom.add(e);break;case 5:this.csa.top.add(e);break;case 6:this.csa.reverse.add(e);break;case 7:(0!==t.rY||0!==t.rZ)&&(e.dom.style.transform=getRotMatrix(t.rY,t.rZ),e.dom.style.webkitTransform=getRotMatrix(t.rY,t.rZ),e.dom.style.OTransform=getRotMatrix(t.rY,t.rZ),e.dom.style.MozTransform=getRotMatrix(t.rY,t.rZ),e.dom.style.MSTransform=getRotMatrix(t.rY,t.rZ))}this.runline.push(e)},t.prototype.time=function(t){if(t-=1,this.position>=this.timeline.length||Math.abs(this.lastPos-t)>=2e3){if(this.seek(t),this.lastPos=t,this.timeline.length<=this.position)return}else this.lastPos=t;for(;this.position<this.timeline.length&&this.timeline[this.position].stime<=t;this.position++)this.send(this.timeline[this.position])},t.prototype.onTimerEvent=function(t,e){for(var i=0;i<e.runline.length;i++){var s=e.runline[i];s.hold||s.time(t)}},t.prototype.finish=function(t){this.stage.removeChild(t.dom);var e=this.runline.indexOf(t);switch(e>=0&&this.runline.splice(e,1),t.mode){default:case 1:this.csa.scroll.remove(t);break;case 2:this.csa.scrollbtm.remove(t);break;case 4:this.csa.bottom.remove(t);break;case 5:this.csa.top.remove(t);break;case 6:this.csa.reverse.remove(t);break;case 7:}},t.prototype.clear=function(){for(;this.runline.length>0;)this.runline[0].finish()},t.prototype.init=function(){this.setBounds()},t.prototype.load=function(t){this.timeline=t,this.timeline.sort(function(t,e){return t.stime>e.stime?2:t.stime<e.stime?-2:t.date>e.date?1:t.date<e.date?-1:null!=t.dbid&&null!=e.dbid?t.dbid>e.dbid?1:t.dbid<e.dbid?-1:0:0})},t}();