var __extends=function(t,o){var r=function(){};r.prototype=o.prototype;var n=new r;n.constructor=t,t.prototype=n};
function BilibiliParser(a){function e(a){return a.replace(/\t/,"\\t")}for(var t=a.getElementsByTagName("d"),r=[],o=0;o<t.length;o++)if(null!=t[o].getAttribute("p")){var n=t[o].getAttribute("p").split(",");if(!t[o].childNodes[0])continue;var l=t[o].childNodes[0].nodeValue,d={};if(d.stime=Math.round(1e3*parseFloat(n[0])),d.mode=parseInt(n[1]),d.size=parseInt(n[2]),d.color=parseInt(n[3]),d.date=parseInt(n[4]),d.pool=parseInt(n[5]),d.position="absolute",null!=n[7]&&(d.dbid=parseInt(n[7])),d.hash=n[6],d.border=!1,d.mode<7)d.text=l.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==d.mode)try{if(adv=JSON.parse(e(l)),d.shadow=!0,d.x=parseFloat(adv[0]),d.y=parseFloat(adv[1]),(Math.floor(d.x)<d.x||Math.floor(d.y)<d.y)&&(d.position="relative"),d.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),d.rZ=0,d.rY=0,adv.length>=7&&(d.rZ=parseInt(adv[5],10),d.rY=parseInt(adv[6],10)),d.motion=[],d.movable=!1,adv.length>=11){d.movable=!0;var s=500,p={x:{from:d.x,to:parseFloat(adv[7]),dur:s,delay:0},y:{from:d.y,to:parseFloat(adv[8]),dur:s,delay:0}};if(""!==adv[9]&&(s=parseInt(adv[9],10),p.x.dur=s,p.y.dur=s),""!==adv[10]&&(p.x.delay=parseInt(adv[10],10),p.y.delay=parseInt(adv[10],10)),adv.length>11&&(d.shadow=adv[11],"true"===d.shadow&&(d.shadow=!0),"false"===d.shadow&&(d.shadow=!1),null!=adv[12]&&(d.font=adv[12]),adv.length>14)){"relative"===d.position&&(console.log("Cannot mix relative and absolute positioning"),d.position="absolute");for(var i=adv[14],v={x:p.x.from,y:p.y.from},u=[],h=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),c=i.split(/[a-zA-Z]/).length-1,f=h.exec(i);null!==f;){switch(f[1]){case"M":v.x=parseInt(f[2],10),v.y=parseInt(f[3],10);break;case"L":u.push({x:{from:v.x,to:parseInt(f[2],10),dur:s/c,delay:0},y:{from:v.y,to:parseInt(f[3],10),dur:s/c,delay:0}}),v.x=parseInt(f[2],10),v.y=parseInt(f[3],10)}f=h.exec(i)}p=null,d.motion=u}null!==p&&d.motion.push(p)}d.dur=2500,adv[3]<12&&(d.dur=1e3*adv[3]);var g=adv[2].split("-");if(null!=g&&g.length>1){var x=parseFloat(g[0]),y=parseFloat(g[1]);d.opacity=x,x!==y&&(d.alpha={from:x,to:y})}}catch(m){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+l)}else 8==d.mode&&(d.code=l);null!=d.text&&(d.text=d.text.replace(/\u25a0/g,"█")),r.push(d)}return r}

function CommentManager(t){this.stage=t,this.options={className:"cmt",indexOffset:0,margin:2,fresh:10},this.commentLine=[],this.nowLine=[],this.position=0,this.lastTime=0,this.width=t.offsetWidth,this.height=t.offsetHeight,this.timer=null,this.nowLinePush=function(t){this.nowLine.push(t),this.nowLine.sort(function(t,i){return t.y>=i.y?1:-1})},this.nowLineRemove=function(t){var i=this.nowLine.indexOf(t);i>=0&&this.nowLine.splice(i,1),this.nowLine.sort(function(t,i){return t.y>=i.y?1:-1})},this.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight},this.init=function(){this.setBounds()},this.startTimer=function(){if(!this.timer){var t=this;this.timer=window.setInterval(function(){var i=(new Date).getTime()-t.lastTime;t.lastTime=(new Date).getTime(),t.onTimerEvent(i)},this.options.fresh)}},this.stopTimer=function(){window.clearInterval(this.timer),this.timer=0},this.send=function(t){var i;if(5===t.mode||4===t.mode)i=new StaticComment(this,t);else{if(1!==t.mode&&2!==t.mode)return void console.log("不支持弹幕类型:"+t.mode);i=new CSSScrollComment(this,t)}i.init(),this.stage.appendChild(i.dom),i.layout(),this.nowLinePush(i)},this.seek=function(t){this.position=0,this.position=this.locate(t)},this.locate=function(t){for(var i=this.position;i<this.commentLine.length;i++){var n=this.commentLine[i];if(n.stime>=t)return i}return this.commentLine.length},this.time=function(t){if(t-=1,!(this.position>=this.commentLine.length)){for(var i=this.locate(t);this.position<i;this.position++)this.send(this.commentLine[this.position]);this.position=i}},this.onTimerEvent=function(t){for(var i=this.nowLine.length,n=0;i>n;n++){var e=this.nowLine[n];e.time(t)||(this.remove(e),i--)}},this.load=function(t){this.commentLine=t,this.commentLine.sort(function(t,i){return t.stime>=i.stime?1:-1})},this.remove=function(t){this.nowLineRemove(t);try{this.stage.removeChild(t.dom)}catch(i){console.log(i),console.log(t)}},this.clear=function(){for(;this.nowLine.length>0;)this.remove(this.nowLine[0])}}
var CommentObject=function(){function t(t,e){this.align=0,this.index=0,this.mode=1,this.stime=0,this.text="",this.timeLeft=4e3,this.lifeTime=4e3,this.movable=!1,this._size=25,this._color=16777215,this.manager=t,e.hasOwnProperty("align")&&(this.align=e.align),e.hasOwnProperty("stime")&&(this.stime=e.stime),e.hasOwnProperty("text")&&(this.text=e.text),e.hasOwnProperty("mode")&&(this.mode=e.mode),e.hasOwnProperty("color")&&(this._color=e.color),e.hasOwnProperty("size")&&(this._size=e.size),e.hasOwnProperty("x")&&(this._x=e.x),e.hasOwnProperty("y")&&(this._y=e.y)}return Object.defineProperty(t.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this.align%2===0?this._x=this.dom.offsetLeft-this.manager.stage.offsetLeft:this._x=this.manager.stage.offsetWidth-(this.dom.offsetLeft-this.manager.stage.offsetLeft+this.dom.offsetWidth)),this._x},set:function(t){this._x=t,this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this.align<2?this._y=this.dom.offsetTop:this._y=this.manager.stage.offsetHeight-(this.dom.offsetTop+this.dom.offsetHeight)),this._y},set:function(t){this._y=t,this.align<2?this.dom.style.top=this._y+"px":this.dom.style.top=this.manager.stage.offsetHeight-t-this.dom.offsetHeight+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var e=t.toString(16);e=e.length>=6?e:new Array(6-e.length+1).join("0")+e,this.dom.style.color="#"+e,0===this._color&&(this.dom.className=this.manager.options.className+" rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=document.createElement("div");t.className=this.manager.options.className,t.appendChild(document.createTextNode(this.text)),t.textContent=this.text,t.innerText=this.text,this.dom=t,this.color=this._color,this.size=this._size},t.prototype.time=function(t){return this.timeLeft-=t,this.timeLeft<0&&(this.timeLeft=0),this.movable&&!this.update()?!1:this.timeLeft>0},t.prototype.update=function(){return!0},t.prototype.layout=function(){},t}();
var ScrollComment=function(t){function i(i,e){switch(t.call(this,i,e),this.mode){case 1:this.align=0;break;case 2:this.align=3;break;case 6:this.align=1}this.movable=!0,this.follow=!1}return __extends(i,t),i.prototype._findOffsetY=function(t,i,e){for(var s,n=e,h=0;h<this.manager.nowLine.length;h++)if(s=this.manager.nowLine[h],s.mode===this.mode&&s.index===t){if(s.y-n>=i)return n;if(!s.follow&&s.timeLeft<=3*s.lifeTime/4)return s.follow=!0,s.y;n=s.y+s.height}return n+i<=this.manager.stage.offsetHeight?n:-1},i.prototype.layout=function(){for(var t=0,i=this.size+2*this.manager.options.margin,e=0,s=-1;0>s;){if(t>10)return void console.error("too many loops...");s=this._findOffsetY(t,i,e),t++,e+=12}this.index=t-1,this.x=this.manager.width,this.y=s},i.prototype.update=function(){var t=this.timeLeft/this.lifeTime*(this.manager.width+this.width)-this.width;return this.x=t,t>-this.width},i}(CommentObject),CSSScrollComment=function(t){function i(){t.apply(this,arguments),this._dirtyCSS=!0}return __extends(i,t),Object.defineProperty(i.prototype,"x",{get:function(){return this.timeLeft/this.lifeTime*(this.manager.width+this.width)-this.width},set:function(t){if("number"==typeof this._x){var i=t-this._x;this._x=t,this.transformCSS("translateX("+i+"px)")}else this._x=t,this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),i.prototype.update=function(){return this._dirtyCSS&&(this.dom.style.transition="transform "+this.timeLeft+"ms linear",this.x=-this.width,this._dirtyCSS=!1),this.x>-this.width},i.prototype.transformCSS=function(t){this.dom.style.transform=t,this.dom.style.webkitTransform=t,this.dom.style.msTransform=t,this.dom.style.oTransform=t},i.prototype.invalidate=function(){t.prototype.invalidate.call(this),this._dirtyCSS=!0},i.prototype.stop=function(){this.dom.style.transition="",this.x=this._x,this._x=null,this.x=this.timeLeft/this.lifeTime*(this.parent.width+this.width)-this.width,this._dirtyCSS=!0},i}(ScrollComment);
var StaticComment=function(t){function e(e,i){t.call(this,e,i),this.align=4==this.mode?3:0}return __extends(e,t),e.prototype._findOffsetY=function(t,e,i){for(var n=i,o=0;o<this.manager.nowLine.length;o++){var s=this.manager.nowLine[o];if(s.mode===this.mode&&s.index===t){if(s.y-n>=e)return n;n=s.y+s.height}}return n+e<=this.manager.stage.offsetHeight?n:-1},e.prototype.layout=function(){for(var t=0,e=this.size+2*this.manager.options.margin,i=0,n=-1;0>n;){if(t>60)return void console.error("Whoops!! too many danmu ...");n=this._findOffsetY(t,e,i),t++,i+=this.manager.options.indexOffset}this.index=t-1,this.x=this.manager.stage.offsetLeft+(this.manager.stage.offsetWidth-this.width)/2,this.y=n},e}(CommentObject);