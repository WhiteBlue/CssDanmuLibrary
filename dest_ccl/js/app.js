function BilibiliParser(t){function i(t){return t.replace(/\t/,"\\t")}for(var e=t.getElementsByTagName("d"),o=[],s=0;s<e.length;s++)if(null!=e[s].getAttribute("p")){var n=e[s].getAttribute("p").split(",");if(!e[s].childNodes[0])continue;var r=e[s].childNodes[0].nodeValue,h={};if(h.stime=Math.round(1e3*parseFloat(n[0])),h.mode=parseInt(n[1]),h.size=parseInt(n[2]),h.color=parseInt(n[3]),h.date=parseInt(n[4]),h.pool=parseInt(n[5]),h.position="absolute",null!=n[7]&&(h.dbid=parseInt(n[7])),h.hash=n[6],h.border=!1,h.mode<7)h.text=r.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==h.mode)try{if(adv=JSON.parse(i(r)),h.shadow=!0,h.x=parseFloat(adv[0]),h.y=parseFloat(adv[1]),(Math.floor(h.x)<h.x||Math.floor(h.y)<h.y)&&(h.position="relative"),h.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),h.rZ=0,h.rY=0,adv.length>=7&&(h.rZ=parseInt(adv[5],10),h.rY=parseInt(adv[6],10)),h.motion=[],h.movable=!1,adv.length>=11){h.movable=!0;var a=500,l={x:{from:h.x,to:parseFloat(adv[7]),dur:a,delay:0},y:{from:h.y,to:parseFloat(adv[8]),dur:a,delay:0}};if(""!==adv[9]&&(a=parseInt(adv[9],10),l.x.dur=a,l.y.dur=a),""!==adv[10]&&(l.x.delay=parseInt(adv[10],10),l.y.delay=parseInt(adv[10],10)),adv.length>11&&(h.shadow=adv[11],"true"===h.shadow&&(h.shadow=!0),"false"===h.shadow&&(h.shadow=!1),null!=adv[12]&&(h.font=adv[12]),adv.length>14)){"relative"===h.position&&(console.log("Cannot mix relative and absolute positioning"),h.position="absolute");for(var p=adv[14],d={x:l.x.from,y:l.y.from},c=[],u=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),m=p.split(/[a-zA-Z]/).length-1,f=u.exec(p);null!==f;){switch(f[1]){case"M":d.x=parseInt(f[2],10),d.y=parseInt(f[3],10);break;case"L":c.push({x:{from:d.x,to:parseInt(f[2],10),dur:a/m,delay:0},y:{from:d.y,to:parseInt(f[3],10),dur:a/m,delay:0}}),d.x=parseInt(f[2],10),d.y=parseInt(f[3],10)}f=u.exec(p)}l=null,h.motion=c}null!==l&&h.motion.push(l)}h.dur=2500,adv[3]<12&&(h.dur=1e3*adv[3]);var y=adv[2].split("-");if(null!=y&&y.length>1){var g=parseFloat(y[0]),_=parseFloat(y[1]);h.opacity=g,g!==_&&(h.alpha={from:g,to:_})}}catch(b){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+r)}else 8==h.mode&&(h.code=r);null!=h.text&&(h.text=h.text.replace(/\u25a0/g,"â–ˆ")),o.push(h)}return o}var __extends=function(t,i){var e=function(){};e.prototype=i.prototype;var o=new e;o.constructor=t,t.prototype=o},BinArray=function(){var t={};return t.bsearch=function(t,i,e){if(0===t.length)return 0;if(e(i,t[0])<0)return 0;if(e(i,t[t.length-1])>=0)return t.length;for(var o=0,s=0,n=0,r=t.length-1;r>=o;){if(s=Math.floor((r+o+1)/2),n++,e(i,t[s-1])>=0&&e(i,t[s])<0)return s;e(i,t[s-1])<0?r=s-1:e(i,t[s])>=0?o=s:console.error("Judge error at : "+e),n>1500&&console.error("Too many run cycles.")}return-1},t.binsert=function(i,e,o){var s=t.bsearch(i,e,o);return i.splice(s,0,e),s},t}(),CoreComment=function(){function t(i,e){if("undefined"==typeof e&&(e={}),this.mode=1,this.stime=0,this.text="",this.ttl=4e3,this.dur=4e3,this.cindex=-1,this.motion=[],this.movable=!0,this._alphaMotion=null,this.absolute=!0,this.align=0,this._alpha=1,this._size=25,this._color=16777215,this._border=!1,this._shadow=!0,this._font="",!i)throw new Error("Comment not bind to comment manager.");if(this.parent=i,e.hasOwnProperty("stime")&&(this.stime=e.stime),e.hasOwnProperty("mode")?this.mode=e.mode:this.mode=1,e.hasOwnProperty("dur")&&(this.dur=e.dur,this.ttl=this.dur),this.dur*=this.parent.options.global.scale,this.ttl*=this.parent.options.global.scale,e.hasOwnProperty("text")&&(this.text=e.text),e.hasOwnProperty("motion")){this._motionStart=[],this._motionEnd=[],this.motion=e.motion;for(var o=0,s=0;s<e.motion.length;s++){this._motionStart.push(o);var n=0;for(var r in e.motion[s]){var h=e.motion[s][r];n=Math.max(h.dur,n),(null===h.easing||void 0===h.easing)&&(e.motion[s][r].easing=t.LINEAR)}o+=n,this._motionEnd.push(o)}this._curMotion=0}e.hasOwnProperty("color")&&(this._color=e.color),e.hasOwnProperty("size")&&(this._size=e.size),e.hasOwnProperty("border")&&(this._border=e.border),e.hasOwnProperty("opacity")&&(this._alpha=e.opacity),e.hasOwnProperty("alpha")&&(this._alphaMotion=e.alpha),e.hasOwnProperty("font")&&(this._font=e.font),e.hasOwnProperty("x")&&(this._x=e.x),e.hasOwnProperty("y")&&(this._y=e.y),e.hasOwnProperty("shadow")&&(this._shadow=e.shadow),e.hasOwnProperty("position")&&"relative"===e.position&&(this.absolute=!1,this.mode<7&&console.warn("Using relative position for CSA comment."))}return t.prototype.init=function(t){"undefined"==typeof t&&(t=null),null!==t?this.dom=t.dom:this.dom=document.createElement("div"),this.dom.className=this.parent.options.global.className,this.dom.appendChild(document.createTextNode(this.text)),this.dom.textContent=this.text,this.dom.innerText=this.text,this.size=this._size,16777215!=this._color&&(this.color=this._color),this.shadow=this._shadow,this._border&&(this.border=this._border),""!==this._font&&(this.font=this._font),void 0!==this._x&&(this.x=this._x),void 0!==this._y&&(this.y=this._y),(1!==this._alpha||this.parent.options.global.opacity<1)&&(this.alpha=this._alpha),this.motion.length>0&&this.animate()},Object.defineProperty(t.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this.align%2===0?this._x=this.dom.offsetLeft:this._x=this.parent.width-this.dom.offsetLeft-this.width),this.absolute?this._x:this._x/this.parent.width},set:function(t){this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this.align<2?this._y=this.dom.offsetTop:this._y=this.parent.height-this.dom.offsetTop-this.height),this.absolute?this._y:this._y/this.parent.height},set:function(t){this._y=t,this.absolute||(this._y*=this.parent.height),this.align<2?this.dom.style.top=this._y+"px":this.dom.style.bottom=this._y+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var i=t.toString(16);i=i.length>=6?i:new Array(6-i.length+1).join("0")+i,this.dom.style.color="#"+i,0===this._color&&(this.dom.className=this.parent.options.global.className+" rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(this._alpha,this.parent.options.global.opacity)+""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t,this._border?this.dom.style.border="1px solid #00ffff":this.dom.style.border="none"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._shadow},set:function(t){this._shadow=t,this._shadow||(this.dom.className=this.parent.options.global.className+" noshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t,this._font.length>0?this.dom.style.fontFamily=this._font:this.dom.style.fontFamily=""},enumerable:!0,configurable:!0}),t.prototype.time=function(t){this.ttl-=t,this.ttl<0&&(this.ttl=0),this.movable&&this.update(),this.ttl<=0&&this.finish()},t.prototype.update=function(){this.animate()},t.prototype.invalidate=function(){this._x=null,this._y=null,this._width=null,this._height=null},t.prototype._execMotion=function(t,i){for(var e in t)if(t.hasOwnProperty(e)){var o=t[e];this[e]=o.easing(Math.min(Math.max(i-o.delay,0),o.dur),o.from,o.to-o.from,o.dur)}},t.prototype.animate=function(){if(this._alphaMotion&&(this.alpha=(this.dur-this.ttl)*(this._alphaMotion.to-this._alphaMotion.from)/this.dur+this._alphaMotion.from),0!==this.motion.length){var t=Math.max(this.ttl,0),i=this.dur-t-this._motionStart[this._curMotion];return this._execMotion(this.motion[this._curMotion],i),this.dur-t>this._motionEnd[this._curMotion]?(this._curMotion++,void(this._curMotion>=this.motion.length&&(this._curMotion=this.motion.length-1))):void 0}},t.prototype.finish=function(){this.parent.finish(this)},t.prototype.toString=function(){return["[",this.stime,"|",this.ttl,"/",this.dur,"]","(",this.mode,")",this.text].join("")},t.LINEAR=function(t,i,e,o){return t*e/o+i},t}(),ScrollComment=function(t){function i(i,e){t.call(this,i,e),this.dur*=this.parent.options.scroll.scale,this.ttl*=this.parent.options.scroll.scale}return __extends(i,t),Object.defineProperty(i.prototype,"alpha",{set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(Math.min(this._alpha,this.parent.options.global.opacity),this.parent.options.scroll.opacity)+""},enumerable:!0,configurable:!0}),i.prototype.init=function(i){"undefined"==typeof i&&(i=null),t.prototype.init.call(this,i),this.x=this.parent.width,this.parent.options.scroll.opacity<1&&(this.alpha=this._alpha),this.absolute=!0},i.prototype.update=function(){this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width},i}(CoreComment),CSSScrollComment=function(t){function i(){t.apply(this,arguments),this._dirtyCSS=!0}return __extends(i,t),Object.defineProperty(i.prototype,"x",{get:function(){return this.ttl/this.dur*(this.parent.width+this.width)-this.width},set:function(t){if("number"==typeof this._x){var i=t-this._x;this._x=t,this.transformCSS("translateX("+i+"px)")}else this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),i.prototype.update=function(){this._dirtyCSS&&(this.dom.style.transition="transform "+this.ttl+"ms linear",this.x=-this.width,this._dirtyCSS=!1)},i.prototype.transformCSS=function(t){this.dom.style.transform=t,this.dom.style.webkitTransform=t,this.dom.style.msTransform=t,this.dom.style.oTransform=t},i.prototype.invalidate=function(){t.prototype.invalidate.call(this),this._dirtyCSS=!0},i.prototype.stop=function(){this.dom.style.transition="",this.x=this._x,this._x=null,this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width,this._dirtyCSS=!0},i}(ScrollComment),CommentSpaceAllocator=function(){function t(t,i){this._pools=[[]],this.avoid=1,this.className="cmt",this._width=t,this._height=i}return t.prototype.willCollide=function(t,i){return t.stime+t.ttl>=i.stime+i.ttl/2},t.prototype.pathCheck=function(t,i,e){for(var o=0;o<e.length;o++)if(e[o].y>t+i.height||e[o].bottom<t);else{if(!(e[o].right<i.x||e[o].x>i.right))return!1;if(this.willCollide(e[o],i))return!1}return!0},t.prototype.assign=function(t,i){for(;this._pools.length<=i;)this._pools.push([]);var e=this._pools[i];if(0===e.length)return t.cindex=i,0;if(this.pathCheck(0,t,e))return t.cindex=i,0;for(var o=0,s=0;s<e.length&&(o=e[s].bottom+this.avoid,!(o+t.height>this._height));s++)if(this.pathCheck(o,t,e))return t.cindex=i,o;return this.assign(t,i+1)},t.prototype.add=function(t){t.height>this._height?(t.cindex=-2,t.y=0):(t.y=this.assign(t,0),BinArray.binsert(this._pools[t.cindex],t,function(t,i){return t.bottom<i.bottom?-1:t.bottom>i.bottom?1:0}))},t.prototype.remove=function(t){if(!(t.cindex<0)){if(t.cindex>=this._pools.length)throw new Error("cindex out of bounds");var i=this._pools[t.cindex].indexOf(t);0>i||this._pools[t.cindex].splice(i,1)}},t.prototype.setBounds=function(t,i){this._width=t,this._height=i},t}(),AnchorCommentSpaceAllocator=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.add=function(i){t.prototype.add.call(this,i),i.x=(this._width-i.width)/2},i.prototype.willCollide=function(t,i){return!0},i.prototype.pathCheck=function(t,i,e){for(var o=t+i.height,s=0;s<e.length;s++)if(!(e[s].y>o||e[s].bottom<t))return!1;return!0},i}(CommentSpaceAllocator),CommentManager=function(){function t(t){var i=0;this.stage=t,this.options={global:{opacity:1,scale:1,className:"cmt"},scroll:{opacity:1,scale:1},limit:0},this.timeline=[],this.runline=[],this.position=0,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new AnchorCommentSpaceAllocator(0,0),bottom:new AnchorCommentSpaceAllocator(0,0),reverse:new CommentSpaceAllocator(0,0),scrollbtm:new CommentSpaceAllocator(0,0)},this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.startTimer=function(){if(!(i>0)){var t=(new Date).getTime(),e=this;i=window.setInterval(function(){var i=(new Date).getTime()-t;t=(new Date).getTime(),e.onTimerEvent(i,e)},10)}},this.stopTimer=function(){window.clearInterval(i),i=0}}return t.prototype.stop=function(){this.stopTimer()},t.prototype.start=function(){this.startTimer()},t.prototype.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight;for(var t in this.csa)this.csa[t].setBounds(this.width,this.height)},t.prototype.seek=function(t){this.position=BinArray.bsearch(this.timeline,t,function(t,i){return t<i.stime?-1:t>i.stime?1:0})},t.prototype.send=function(t){var i=1===t.mode||2===t.mode||6===t.mode?new CSSScrollComment(this,t):i=new CoreComment(this,t);switch(i.mode){case 1:i.align=0;break;case 2:i.align=2;break;case 4:i.align=2;break;case 5:i.align=0;break;case 6:i.align=1}switch(i.init(),this.stage.appendChild(i.dom),i.mode){case 1:this.csa.scroll.add(i);break;case 2:this.csa.scrollbtm.add(i);break;case 4:this.csa.bottom.add(i);break;case 5:this.csa.top.add(i);break;case 6:this.csa.reverse.add(i);break;case 7:(0!==t.rY||0!==t.rZ)&&(i.dom.style.transform=getRotMatrix(t.rY,t.rZ),i.dom.style.webkitTransform=getRotMatrix(t.rY,t.rZ),i.dom.style.OTransform=getRotMatrix(t.rY,t.rZ),i.dom.style.MozTransform=getRotMatrix(t.rY,t.rZ),i.dom.style.MSTransform=getRotMatrix(t.rY,t.rZ))}this.runline.push(i)},t.prototype.time=function(t){if(t-=1,this.position>=this.timeline.length||Math.abs(this.lastPos-t)>=2e3){if(this.seek(t),this.lastPos=t,this.timeline.length<=this.position)return}else this.lastPos=t;for(;this.position<this.timeline.length&&this.timeline[this.position].stime<=t;this.position++)this.send(this.timeline[this.position])},t.prototype.onTimerEvent=function(t,i){for(var e=0;e<i.runline.length;e++){var o=i.runline[e];o.time(t)}},t.prototype.finish=function(t){this.stage.removeChild(t.dom);var i=this.runline.indexOf(t);switch(i>=0&&this.runline.splice(i,1),t.mode){default:case 1:this.csa.scroll.remove(t);break;case 2:this.csa.scrollbtm.remove(t);break;case 4:this.csa.bottom.remove(t);break;case 5:this.csa.top.remove(t);break;case 6:this.csa.reverse.remove(t);break;case 7:}},t.prototype.clear=function(){for(;this.runline.length>0;)this.runline[0].finish()},t.prototype.init=function(){this.setBounds()},t.prototype.load=function(t){this.timeline=t,this.timeline.sort(function(t,i){return t.stime>i.stime?2:t.stime<i.stime?-2:t.date>i.date?1:t.date<i.date?-1:null!=t.dbid&&null!=i.dbid?t.dbid>i.dbid?1:t.dbid<i.dbid?-1:0:0})},t}();