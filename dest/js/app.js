var __extends=function(t,o){var r=function(){};r.prototype=o.prototype;var n=new r;n.constructor=t,t.prototype=n};
function BilibiliParser(a){function e(a){return a.replace(/\t/,"\\t")}for(var t=a.getElementsByTagName("d"),r=[],o=0;o<t.length;o++)if(null!=t[o].getAttribute("p")){var n=t[o].getAttribute("p").split(",");if(!t[o].childNodes[0])continue;var l=t[o].childNodes[0].nodeValue,d={};if(d.stime=Math.round(1e3*parseFloat(n[0])),d.mode=parseInt(n[1]),d.size=parseInt(n[2]),d.color=parseInt(n[3]),d.date=parseInt(n[4]),d.pool=parseInt(n[5]),d.position="absolute",null!=n[7]&&(d.dbid=parseInt(n[7])),d.hash=n[6],d.border=!1,d.mode<7)d.text=l.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==d.mode)try{if(adv=JSON.parse(e(l)),d.shadow=!0,d.x=parseFloat(adv[0]),d.y=parseFloat(adv[1]),(Math.floor(d.x)<d.x||Math.floor(d.y)<d.y)&&(d.position="relative"),d.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),d.rZ=0,d.rY=0,adv.length>=7&&(d.rZ=parseInt(adv[5],10),d.rY=parseInt(adv[6],10)),d.motion=[],d.movable=!1,adv.length>=11){d.movable=!0;var s=500,p={x:{from:d.x,to:parseFloat(adv[7]),dur:s,delay:0},y:{from:d.y,to:parseFloat(adv[8]),dur:s,delay:0}};if(""!==adv[9]&&(s=parseInt(adv[9],10),p.x.dur=s,p.y.dur=s),""!==adv[10]&&(p.x.delay=parseInt(adv[10],10),p.y.delay=parseInt(adv[10],10)),adv.length>11&&(d.shadow=adv[11],"true"===d.shadow&&(d.shadow=!0),"false"===d.shadow&&(d.shadow=!1),null!=adv[12]&&(d.font=adv[12]),adv.length>14)){"relative"===d.position&&(console.log("Cannot mix relative and absolute positioning"),d.position="absolute");for(var i=adv[14],v={x:p.x.from,y:p.y.from},u=[],h=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),c=i.split(/[a-zA-Z]/).length-1,f=h.exec(i);null!==f;){switch(f[1]){case"M":v.x=parseInt(f[2],10),v.y=parseInt(f[3],10);break;case"L":u.push({x:{from:v.x,to:parseInt(f[2],10),dur:s/c,delay:0},y:{from:v.y,to:parseInt(f[3],10),dur:s/c,delay:0}}),v.x=parseInt(f[2],10),v.y=parseInt(f[3],10)}f=h.exec(i)}p=null,d.motion=u}null!==p&&d.motion.push(p)}d.dur=2500,adv[3]<12&&(d.dur=1e3*adv[3]);var g=adv[2].split("-");if(null!=g&&g.length>1){var x=parseFloat(g[0]),y=parseFloat(g[1]);d.opacity=x,x!==y&&(d.alpha={from:x,to:y})}}catch(m){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+l)}else 8==d.mode&&(d.code=l);null!=d.text&&(d.text=d.text.replace(/\u25a0/g,"█")),r.push(d)}return r}
function CommentManager(i){this.stage=i,this.options={indexOffset:0,className:"cmt",margin:1,fresh:10,global:{opacity:1,scale:1},scroll:{opacity:1,scale:1},limit:0},this.commentLine=[],this.nowLine=[],this.position=0,this.width=i.offsetWidth,this.height=i.offsetHeight,this.startTimer=function(){for(var i=0;i<this.nowLine.length;i++)this.nowLine[i].control&&this.nowLine[i].start()},this.stopTimer=function(){for(var i=0;i<this.nowLine.length;i++)this.nowLine[i].control&&this.nowLine[i].stop()},this.nowLinePush=function(i){if(0===this.nowLine.length)return void this.nowLine.push(i);if(this.nowLine[this.nowLine.length-1].offsetY()<=i.offsetY())return void this.nowLine.push(i);if(this.nowLine[0].offsetY()>=i.offsetY())return void this.nowLine.unshift(i);for(var t=0,n=this.nowLine.length-1,o=0,e=0;n>t;){if(o=Math.floor((n+t+1)/2),this.nowLine[o-1].offsetY()<=i.offsetY()&&this.nowLine[o].offsetY()>=i.offsetY()){e=o;break}this.nowLine[o-1].offsetY()>i.offsetY()?n=o-1:t=o}this.nowLine.splice(e,0,i)},this.nowLineRemove=function(i){var t=this.nowLine.indexOf(i);t>=0&&this.nowLine.splice(t,1)},this.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight},this.init=function(){this.setBounds(),this.position=0},this.send=function(i){var t;if(5===i.mode||4===i.mode)t=new StaticComment(this,i);else{if(1!==i.mode&&2!==i.mode&&6!=i.mode)return void console.log("不支持的弹幕");t=new ScrollComment(this,i)}t.init(),this.stage.appendChild(t.dom),t.layout(),this.nowLinePush(t)},this.seek=function(i){this.position=0,this.position=this.locate(i)},this.locate=function(i){for(var t=this.position;t<this.commentLine.length;t++){var n=this.commentLine[t];if(n.stime>=i)return t}return this.commentLine.length},this.time=function(i){if(i-=1,!(this.position>=this.commentLine.length)){for(var t=this.locate(i);this.position<t;this.position++)this.send(this.commentLine[this.position]);this.position=t;for(var n=this.nowLine.length,o=0;n>o;o++){var e=this.nowLine[o];e.checkTime(i)||(this.remove(e),n--)}}},this.load=function(i){this.commentLine=i,this.position=0,this.commentLine.sort(function(i,t){return i.stime>=t.stime?1:-1})},this.remove=function(i){this.nowLineRemove(i);try{this.stage.removeChild(i.dom)}catch(t){console.log(t),console.log(i)}},this.clear=function(){for(;this.nowLine.length>0;)this.remove(this.nowLine[0])}}
var CommentObject=function(){function t(t,i){this.align=0,this.index=0,this.mode=1,this.stime=0,this.text="",this.lifeTime=4e3*t.options.global.scale,this.timeLeft=4e3*t.options.global.scale,this._size=25,this._color=16777215,this.manager=t,this.control=!1,i.hasOwnProperty("align")&&(this.align=i.align),i.hasOwnProperty("stime")&&(this.stime=i.stime),i.hasOwnProperty("text")&&(this.text=i.text),i.hasOwnProperty("mode")&&(this.mode=i.mode),i.hasOwnProperty("color")&&(this._color=i.color),i.hasOwnProperty("size")&&(this._size=i.size),i.hasOwnProperty("x")&&(this._x=i.x),i.hasOwnProperty("y")&&(this._y=i.y),i.hasOwnProperty("border")&&(this._border=i.border)}return t.prototype.offsetX=function(t){return null===t||void 0===t?(null!==this._x&&void 0!==this._x||(this.align%2===0?this._x=this.dom.offsetLeft-this.manager.stage.offsetLeft:this._x=this.manager.stage.offsetWidth-(this.dom.offsetLeft-this.manager.stage.offsetLeft+this.dom.offsetWidth)),this._x):(this._x=t,void(this.align%2===0?this.dom.style.right=this._x+"px":this.dom.style.left=this._x+"px"))},t.prototype.offsetY=function(t){return null===t||void 0===t?(null!==this._y&&void 0!==this._y||(this.align<2?this._y=this.dom.offsetTop:this._y=this.manager.stage.offsetHeight-(this.dom.offsetTop+this.dom.offsetHeight)),this._y):(this._y=t,void(this.align<2?this.dom.style.top=this._y+"px":this.dom.style.top=this.manager.stage.offsetHeight-t-this.dom.offsetHeight+"px"))},t.prototype.Color=function(t){if(null===t||void 0===t)return this._color;this._color=t;var i=t.toString(16);i=i.length>=6?i:new Array(6-i.length+1).join("0")+i,0!==i.indexOf("#")&&(i="#".concat(i)),this.dom.style.color=i,0===this._color&&(this.dom.className=this.manager.options.className+" rshadow")},t.prototype.Width=function(t){return null===t||void 0===t?(null!==this._width&&void 0!==this._width||(this._width=this.dom.offsetWidth),this._width):(this._width=t,void(this.dom.style.width=this._width+"px"))},t.prototype.Height=function(t){return null===t||void 0===t?(null!==this._height&&void 0!==this._height||(this._height=this.dom.offsetHeight),this._height):(this._height=t,void(this.dom.style.height=this._height+"px"))},t.prototype.Size=function(t){return null===t||void 0===t?this._size:(this._size=t,void(this.dom.style.fontSize=this._size+"px"))},t.prototype.Border=function(t){return null===t||void 0===t?this._border:(this._border=t,void(this.dom.style.border=t))},t.prototype.init=function(){var t=document.createElement("div");t.className=this.manager.options.className,t.appendChild(document.createTextNode(this.text)),t.textContent=this.text,t.innerText=this.text,this.dom=t,this.Color(this._color),this.Size(this._size)},t.prototype.checkTime=function(t){return this.timeLeft=this.stime+this.lifeTime-t,this.stime+this.lifeTime>t},t.prototype.layout=function(){},t.prototype.stop=function(){},t}();
var ScrollComment=function(t){function i(i,e){switch(t.call(this,i,e),this.mode){case 1:this.align=0;break;case 2:this.align=2;break;case 6:this.align=1}this.follow=!1,this.control=!0,this.lifeTime*=i.options.scroll.scale}return __extends(i,t),i.prototype._findOffsetY=function(t,i,e){for(var o,n=e,s=0;s<this.manager.nowLine.length;s++)if(o=this.manager.nowLine[s],o.mode===this.mode&&o.index===t){if(o.offsetY()-n>=i)return n;if(!o.follow&&o.timeLeft<=.5*o.lifeTime)return o.follow=!0,o.offsetY();n=o.offsetY()+o.Height()}return n+i<=this.manager.stage.offsetHeight?n:-1},i.prototype.layout=function(){for(var t=0,i=this.Size()+2*this.manager.options.margin,e=0,o=-1;0>o;){if(t>1e3)return;o=this._findOffsetY(t,i,e),t++,e+=this.manager.options.indexOffset}this.index=t-1,this.offsetY(o),this.offsetX(-this.Width()),this.moveAnimation()},i.prototype.moveAnimation=function(){var t=this.align%2==0?"-left ":"-right ",i="cmt-move"+t+this.lifeTime/1e3+"s linear";this.dom.style.animation=i,this.dom.style["-webkit-animation"]=i,this.dom.style["-moz-animation"]=i,this.dom.style["-o-animation"]=i},i.prototype.start=function(){this.dom.style["animation-play-state"]="running"},i.prototype.stop=function(){this.dom.style["animation-play-state"]="paused"},i}(CommentObject);
var StaticComment=function(t){function e(e,i){t.call(this,e,i),this.align=4==this.mode?3:0}return __extends(e,t),e.prototype._findOffsetY=function(t,e,i){var n=i;for(var s in this.manager.nowLine){var f=this.manager.nowLine[s];if(f.mode===this.mode&&f.index===t){if(f.offsetY()-n>=e)return n;n=f.offsetY()+f.Height()}}return n+e<=this.manager.stage.offsetHeight?n:-1},e.prototype.layout=function(){for(var t=0,e=this.Height()+2*this.manager.options.margin,i=0,n=-1;0>n;)n=this._findOffsetY(t,e,i),t++,i+=this.manager.options.indexOffset;this.index=t-1,this.offsetX(this.manager.stage.offsetLeft+(this.manager.stage.offsetWidth-this.Width())/2),this.offsetY(n)},e}(CommentObject);