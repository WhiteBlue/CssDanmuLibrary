var __extends=function(t,o){var r=function(){};r.prototype=o.prototype;var n=new r;n.constructor=t,t.prototype=n};
function BilibiliParser(a){function e(a){return a.replace(/\t/,"\\t")}for(var t=a.getElementsByTagName("d"),r=[],o=0;o<t.length;o++)if(null!=t[o].getAttribute("p")){var n=t[o].getAttribute("p").split(",");if(!t[o].childNodes[0])continue;var l=t[o].childNodes[0].nodeValue,d={};if(d.stime=Math.round(1e3*parseFloat(n[0])),d.mode=parseInt(n[1]),d.size=parseInt(n[2]),d.color=parseInt(n[3]),d.date=parseInt(n[4]),d.pool=parseInt(n[5]),d.position="absolute",null!=n[7]&&(d.dbid=parseInt(n[7])),d.hash=n[6],d.border=!1,d.mode<7)d.text=l.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==d.mode)try{if(adv=JSON.parse(e(l)),d.shadow=!0,d.x=parseFloat(adv[0]),d.y=parseFloat(adv[1]),(Math.floor(d.x)<d.x||Math.floor(d.y)<d.y)&&(d.position="relative"),d.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),d.rZ=0,d.rY=0,adv.length>=7&&(d.rZ=parseInt(adv[5],10),d.rY=parseInt(adv[6],10)),d.motion=[],d.movable=!1,adv.length>=11){d.movable=!0;var s=500,p={x:{from:d.x,to:parseFloat(adv[7]),dur:s,delay:0},y:{from:d.y,to:parseFloat(adv[8]),dur:s,delay:0}};if(""!==adv[9]&&(s=parseInt(adv[9],10),p.x.dur=s,p.y.dur=s),""!==adv[10]&&(p.x.delay=parseInt(adv[10],10),p.y.delay=parseInt(adv[10],10)),adv.length>11&&(d.shadow=adv[11],"true"===d.shadow&&(d.shadow=!0),"false"===d.shadow&&(d.shadow=!1),null!=adv[12]&&(d.font=adv[12]),adv.length>14)){"relative"===d.position&&(console.log("Cannot mix relative and absolute positioning"),d.position="absolute");for(var i=adv[14],v={x:p.x.from,y:p.y.from},u=[],h=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),c=i.split(/[a-zA-Z]/).length-1,f=h.exec(i);null!==f;){switch(f[1]){case"M":v.x=parseInt(f[2],10),v.y=parseInt(f[3],10);break;case"L":u.push({x:{from:v.x,to:parseInt(f[2],10),dur:s/c,delay:0},y:{from:v.y,to:parseInt(f[3],10),dur:s/c,delay:0}}),v.x=parseInt(f[2],10),v.y=parseInt(f[3],10)}f=h.exec(i)}p=null,d.motion=u}null!==p&&d.motion.push(p)}d.dur=2500,adv[3]<12&&(d.dur=1e3*adv[3]);var g=adv[2].split("-");if(null!=g&&g.length>1){var x=parseFloat(g[0]),y=parseFloat(g[1]);d.opacity=x,x!==y&&(d.alpha={from:x,to:y})}}catch(m){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+l)}else 8==d.mode&&(d.code=l);null!=d.text&&(d.text=d.text.replace(/\u25a0/g,"█")),r.push(d)}return r}
function CommentManager(t){this.stage=t,this.options={className:"cmt",indexOffset:0,margin:1,fresh:10},this.commentLine=[],this.nowLine=[],this.position=0,this.width=t.offsetWidth,this.height=t.offsetHeight,this.startTimer=function(){for(var t=0;t<this.nowLine.length;t++)this.nowLine[t].control&&this.nowLine[t].start()},this.stopTimer=function(){for(var t=0;t<this.nowLine.length;t++)this.nowLine[t].control&&this.nowLine[t].stop()},this.nowLinePush=function(t){if(0===this.nowLine.length)return void this.nowLine.push(t);if(this.nowLine[this.nowLine.length-1].y<=t.y)return void this.nowLine.push(t);if(this.nowLine[0].y>=t.y)return void this.nowLine.unshift(t);for(var i=0,n=this.nowLine.length-1,e=0,s=0;n>i;){if(e=Math.floor((n+i+1)/2),this.nowLine[e-1].y<=t.y&&this.nowLine[e].y>=t.y){s=e;break}this.nowLine[e-1].y>t.y?n=e-1:i=e}this.nowLine.splice(s,0,t)},this.nowLineRemove=function(t){var i=this.nowLine.indexOf(t);i>=0&&this.nowLine.splice(i,1)},this.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.initAnimation()},this.init=function(){this.setBounds()},this.send=function(t){var i;if(5===t.mode||4===t.mode)i=new StaticComment(this,t);else{if(1!==t.mode&&2!==t.mode)return void console.log("不支持的弹幕");i=new ScrollComment(this,t)}i.init(),this.stage.appendChild(i.dom),i.layout(),this.nowLinePush(i)},this.seek=function(t){this.position=0,this.position=this.locate(t)},this.locate=function(t){for(var i=this.position;i<this.commentLine.length;i++){var n=this.commentLine[i];if(n.stime>=t)return i}return this.commentLine.length},this.time=function(t){if(t-=1,!(this.position>=this.commentLine.length)){for(var i=this.locate(t);this.position<i;this.position++)this.send(this.commentLine[this.position]);this.position=i;for(var n=this.nowLine.length,e=0;n>e;e++){var s=this.nowLine[e];s.checkTime(t)||(this.remove(s),n--)}}},this.load=function(t){this.commentLine=t,this.commentLine.sort(function(t,i){return t.stime>=i.stime?1:-1})},this.remove=function(t){this.nowLineRemove(t);try{this.stage.removeChild(t.dom)}catch(i){console.log(i),console.log(t)}},this.clear=function(){for(;this.nowLine.length>0;)this.remove(this.nowLine[0])},this.initAnimation=function(){var t="@keyframes cmt-move { to {  right: "+this.width+"px;  } }";if(document.styleSheets&&document.styleSheets.length){for(var i=0;i<document.styleSheets[0].rules.length;i++)if("cmt-move"===document.styleSheets[0].rules[i].name){document.styleSheets[0].removeRule(i);break}document.styleSheets[0].insertRule(t,0)}}}
var CommentObject=function(){function t(t,e){this.align=0,this.index=0,this.mode=1,this.stime=0,this.text="",this.lifeTime=4e3,this._size=25,this._color=16777215,this.manager=t,this.control=!1,e.hasOwnProperty("align")&&(this.align=e.align),e.hasOwnProperty("stime")&&(this.stime=e.stime),e.hasOwnProperty("text")&&(this.text=e.text),e.hasOwnProperty("mode")&&(this.mode=e.mode),e.hasOwnProperty("color")&&(this._color=e.color),e.hasOwnProperty("size")&&(this._size=e.size),e.hasOwnProperty("x")&&(this._x=e.x),e.hasOwnProperty("y")&&(this._y=e.y)}return Object.defineProperty(t.prototype,"x",{get:function(){return(null===this._x||void 0===this._x)&&(this.align%2===0?this._x=this.dom.offsetLeft-this.manager.stage.offsetLeft:this._x=this.manager.stage.offsetWidth-(this.dom.offsetLeft-this.manager.stage.offsetLeft+this.dom.offsetWidth)),this._x},set:function(t){this._x=t,this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return(null===this._y||void 0===this._y)&&(this.align<2?this._y=this.dom.offsetTop:this._y=this.manager.stage.offsetHeight-(this.dom.offsetTop+this.dom.offsetHeight)),this._y},set:function(t){this._y=t,this.align<2?this.dom.style.top=this._y+"px":this.dom.style.top=this.manager.stage.offsetHeight-t-this.dom.offsetHeight+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var e=t.toString(16);e=e.length>=6?e:new Array(6-e.length+1).join("0")+e,this.dom.style.color="#"+e,0===this._color&&(this.dom.className=this.manager.options.className+" rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return(null===this._width||void 0===this._width)&&(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return(null===this._height||void 0===this._height)&&(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=document.createElement("div");t.className=this.manager.options.className,t.appendChild(document.createTextNode(this.text)),t.textContent=this.text,t.innerText=this.text,this.dom=t,this.color=this._color,this.size=this._size},t.prototype.checkTime=function(t){return this.stime+this.lifeTime>t},t.prototype.layout=function(){},t.prototype.stop=function(){},t}();
var ScrollComment=function(t){function i(i,o){switch(t.call(this,i,o),this.mode){case 1:this.align=1;break;case 2:this.align=2}this.follow=!1,this.control=!0}return __extends(i,t),i.prototype._findOffsetY=function(t,i,o){for(var n,e=o,s=0;s<this.manager.nowLine.length;s++)if(n=this.manager.nowLine[s],n.mode===this.mode&&n.index===t){if(n.y-e>=i)return e;if(!n.follow&&n.timeLeft<=3*n.lifeTime/4)return n.follow=!0,n.y;e=n.y+n.height}return e+i<=this.manager.stage.offsetHeight?e:-1},i.prototype.transformCSS=function(t){this.dom.style.transform=t,this.dom.style.webkitTransform=t,this.dom.style.msTransform=t,this.dom.style.oTransform=t},i.prototype.layout=function(){for(var t=0,i=this.size+2*this.manager.options.margin,o=0,n=-1;0>n;){if(t>1e3)return void console.error("Whoops!! too many loops ...");n=this._findOffsetY(t,i,o),t++,o+=this.manager.options.indexOffset}this.index=t-1,this.y=n,this.x=-this.width,this.moveAnimation()},i.prototype.moveAnimation=function(){this.dom.style.animation="cmt-move "+this.lifeTime+"ms linear",this.dom.style["animation-play-state"]="running"},i.prototype.move=function(t){this.transformCSS("translateX("+t+"px)"),this.dom.style.transition="transform "+this.lifeTime+"ms linear"},i.prototype.start=function(){this.dom.style["animation-play-state"]="running"},i.prototype.stop=function(){this.dom.style["animation-play-state"]="paused"},i}(CommentObject);
var StaticComment=function(t){function e(e,i){t.call(this,e,i),this.align=4==this.mode?3:0}return __extends(e,t),e.prototype._findOffsetY=function(t,e,i){for(var n=i,o=0;o<this.manager.nowLine.length;o++){var s=this.manager.nowLine[o];if(s.mode===this.mode&&s.index===t){if(s.y-n>=e)return n;n=s.y+s.height}}return n+e<=this.manager.stage.offsetHeight?n:-1},e.prototype.layout=function(){for(var t=0,e=this.size+2*this.manager.options.margin,i=0,n=-1;0>n;){if(t>1e3)return void console.error("Whoops!! too many loops ...");n=this._findOffsetY(t,e,i),t++,i+=this.manager.options.indexOffset}this.index=t-1,this.x=this.manager.stage.offsetLeft+(this.manager.stage.offsetWidth-this.width)/2,this.y=n},e}(CommentObject);